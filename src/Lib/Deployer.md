# Деплойщик
Класс [Deployer](Deployer.php)
Перейти к [использованию](#usage)

## Идея
Деплой подразумевает проведение нескольких операций:
* обновление репозитория (git pull)
* обновление зависимостей (composer update)
* миграции БД (phinx migrate)
* мелочёвка (чистка кеша, обновление счётчика версий)

Как минимум это должно быть автоматизировано, а ещё лучше, если дерлоить не в текущей папке.

Основные операции очень затратны: git pull и composer update обращаются к внешним данным по сети, миграции тоже могут длиться долго. Ещё ужаснее, если какая-то из операций закончится ошибкой.

## Решение
Создаётся несколько копий проекта и один симлинк. Веб-сервер и записи в кронтабе используют этот симлинк. Все операции деплоя (git pull, composer update, ...) происходят в следующей папке. При успешном завершении симлинк переключается, иначе шлётся оповещение об ошибке, и работает старая версия.

Возможность деплоить в текущую папку сохранена. Удобно для обновления тестового репозитория, например.

## Доделать
Откат:
* проверить, что сейчас не самая ранняя версия
* узнать предыдущую версию миграций
* откатить миграции до предыдущей версии
* очистить кеш и переключить симлинк

## <a name="usage"></a>Использование
### Конфигурация
Класс Deployer - абстрактный, потому что ему нужно задать много локальных настроек (в основном, локальные пути).

Соответственно, нужно создать класс-наследник. Что обязательно нужно определить:
* свойство `_mainRoot` - главный симлинк, корень, накоторый смотрит веб-сервер
* свойство `_currentRoot` - текущий настоящий корень, на который смотрит симлинк в данный момент. Скорее всего это константа ROOT
* свойство `_rotateDeployFolders` - список папок, между которыми будет переключение
* свойство `_repoName` - название текущего репозитория, для дополнительных проверок
* свойство `_copyFileList` - список файлов, которые нужно переносить копированием (например, локальные конфиги, которых нет в репозитории). Указывается либо полный путь, либо путь относительно корня.
* свойство `_versionFile` - файл с номером версии, номер инкрементируется при деплое. Указывается либо полный путь, либо путь относительно корня.
* свойство `_cakeSubPath` - если кейк лежит не в корне проекта, то указать путь до него
* свойство `_autoMigrate` - явно указать, разворачивать миграции или нет. (Для деплойщика тестового окружения)
* Для деплойщика тестового окружения переопределить метод `_isDeployEnvironment()`

Режим деплоя в текущую папку:
* не задавать свойства `mainRoot`, `currentRoot`, `rotateDeployFolders`, вместо них задать свойство `_singleRoot`

### Запуск
Метод `deploy()`. Аргументы:
* Название деплоящегося репозитория. Для проверки того, что деплоится то, что нужно
* Название деплоящейся ветки. Для такой же проверки. (На продакшне будет деплоиться только мастер, на тесте - только текущая ветка)
* Хеш коммита, для записи в лог, просто так
* Текущая версия, она инкрементируется и запишется в файл.

Есть метод `deployInBg()` для запуска деплоя асинхронно. Например, если деплой происходит по запросу от веб-сервера, чтобы реквест не висел и не отваливался по таймауту.
Для его использования нужно расширить `DeploymentShell` и определить в нём методы `_getDeployer()` и `_getVersion()`